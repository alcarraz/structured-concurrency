\section{Concurrencia Estructurada}\label{sec:la-solucion:-structured-concurrency}
\subsection{Ejemplo}
\begin{frame}[fragile]
\begin{minted}[fontsize=\footnotesize]{java}
// STRUCTURED: Código que se lee como se ejecuta
public TransactionResult processTransaction(TransactionRequest request) throws InterruptedException {
    ValidationResult cardResult = cardValidationService.validate(request.cardNumber());
    if (!cardResult.success()) return TransactionResult.failure(cardResult.message());

    try (var scope = StructuredTaskScope.open(StructuredTaskScope.Joiner.awaitAll())) {
        var balanceTask = scope.fork(() ->
            balanceService.validate(request.cardNumber(), request.amount()));
        // ... más validaciones paralelas

        scope.join();

        List<ValidationResult> results = List.of(balanceTask.get(), pinTask.get(), xxx);
        Optional<ValidationResult> failure = results.stream().filter(r -> !r.success()).findFirst();
        if (failure.isPresent())
            return TransactionResult.failure(failure.get().message());
    }
    ValidationResult debitResult = balanceService.debit(request.cardNumber(), request.amount());
    return debitResult.success() ? TransactionResult.success(xxx) : TransactionResult.failure(xxx);
}
\end{minted}
\end{frame}
\subsection{Características}
\begin{frame}
\begin{exampleblock}{Simplicidad y Poder}
\begin{itemize}
\item \textbf{Código Legible:} Se lee como se ejecuta.
\item \textbf{Manejo de errores simple:} Excepciones tradicionales.
\item \textbf{Manejo de recursos:} Try-with-resources automático.
\item \textbf{Depuración:} Stack traces normales.
\item \textbf{Rendimiento:} Misma ejecución paralela.
\end{itemize}
\end{exampleblock}

\begin{block}{Principios Clave}
\begin{itemize}
\item \textbf{Ciclo de vida estructurado:} Tareas anidadas mueren con el alcance.
\item \textbf{Fallar tempranamente por defecto:} \texttt{open()} cancela automáticamente si una tarea falla.
\item \textbf{Opcionalmente, esperar por todos:} \texttt{open(awaitAll())} para recopilar todos los resultados.
\item \textbf{Observabilidad:} Mejor monitoreo y depuración, volcado estructurado de hilos.
\end{itemize}
\end{block}
\end{frame}

%\begin{frame}[fragile]
%%! language = JShellLanguage
%\begin{minted}[fontsize=\footnotesize]{java}
%// FAIL-FAST: Cancela automáticamente al primer fallo
%try (var scope = StructuredTaskScope.open()) {
%    var balanceTask = scope.fork(() -> {
%        ValidationResult result = balanceService.validate(request.cardNumber(), request.amount());
%        if (!result.success())
%            throw new RuntimeException(result.message());
%        return result;
%    });
%    // ... más validaciones
%
%    scope.join();  // Cancela tareas restantes al primer fallo
%
%    ValidationResult debitResult = balanceService.debit(request.cardNumber(), request.amount());
%    return TransactionResult.success(xxx);
%
%} catch (StructuredTaskScope.FailedException e) {
%    return TransactionResult.failure("FAIL-FAST: " + e.getMessage());
%}
%\end{minted}
%\end{frame}
\subsection{Demo: Structured Concurrency con REST API}
\begin{frame}[fragile]
    \begin{block}{Probemos Structured Concurrency}
        \begin{minted}[fontsize=\scriptsize]{bash}
curl -X POST http://localhost:8080/api/structured/normal \
  -H "Content-Type: application/json" \
  -d '{
    "cardNumber": "1234-5678-9012-3456",
    "expirationDate": "2512",
    "pin": "1234",
    "amount": 100.00,
    "merchant": "Demo Store"
  }'
        \end{minted}
    \end{block}

    \vspace{1em}

    \begin{exampleblock}{Respuesta esperada}
        \begin{minted}[fontsize=\tiny]{json}
{
  "success": true,
  "transactionId": "uuid-here",
  "amount": 100.00,
  "message": "Transaction processed successfully",
  "processingTimeMs": 520
}
        \end{minted}
    \end{exampleblock}

    \vspace{0.5em}
    \begin{alertblock}{¡Mismo performance, código más simple!}
        Sin callbacks, sin CompletionException, código que lee como se ejecuta.
    \end{alertblock}
\end{frame}

